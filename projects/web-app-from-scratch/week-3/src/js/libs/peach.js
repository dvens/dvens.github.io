// Author: www.dylanvens.com
!function(){"use strict";var e=document.querySelector("body"),t=document.querySelector("[peach-view]"),r=(document.querySelector("[peach-view-holder]"),function(){var e=this;e.params,e.config,e.routes=[],e.serviceHolder={},e.controllerHolder={},e.controllerDependencies={},e.moduleHolder={},e.setAppConfig=function(t){e.config=t()},e.run=function(t,r){var o=e.config;"init"===t?(r(o),window.addEventListener("hashchange",e.routeMatch.bind(this)),window.addEventListener("load",e.routeMatch.bind(this))):r(o)}});r.prototype.route=function(e){var t=this;return t.routes.push(e),this},r.prototype.controller=function(t,r){var o=this,n=[].slice.call(e.querySelectorAll("[peach-controller="+t+"]")),i=r[r.length-1],l=r.slice(0,-1);"function"==typeof i?(o.controllerHolder[t]=i,o.controllerDependencies[t]=l):console.warn("_fn is not a function: "._fn),n.length&&n.forEach(function(e){o.parse(e,t)})},r.prototype.service=function(e,t){var r,o=this,n=t[t.length-1],i=t.slice(0,-1);if("function"==typeof n){var l={$xhr:o.request,$render:this.renderTemplate};r=this.loadDependencies(i),r.push(o.config,l),o.serviceHolder[e]=n.apply(this,r)}else console.warn("_fn is not a function: ",n)},r.prototype.module=function(e,t){var r,o=this,n=t[t.length-1],i=t.slice(0,-1);if("function"==typeof n){var l={$xhr:o.request,$render:this.renderTemplate};r=this.loadDependencies(i),r.push(o.config,l),o.moduleHolder[e]=n.apply(this,r)}else console.warn("_fn is not a function: ",n)},r.prototype.loadDependencies=function(e){var t=[];if(!e)return void console.warn("No controller or dependency is set: ",e);for(var r=0;r<e.length;r++)"string"==typeof e[r]&&(this.moduleHolder.hasOwnProperty(e[r])?t.push(this.loadModule(e[r])):this.serviceHolder.hasOwnProperty(e[r])?t.push(this.loadService(e[r])):console.warn("Could not find: "+e[r]));return t},r.prototype.loadInlineController=function(e,t,r){var o=this,n=o.serviceHolder[e.service];o.initRouteController(n,t,r)},r.prototype.loadModule=function(e){return this.moduleHolder[e]},r.prototype.loadService=function(e){return this.serviceHolder[e]},r.prototype.routeMatch=function(){for(var e=this,r=window.location.hash.slice(1)||"/",o=[],n=0;n<e.routes.length;n++){var i=e.routes[n],l=i.url.replace(/:[a-z]+/g,"([a-z0-9-]+)"),s=new RegExp("^"+l+"$");if(s.test(r)){var c=i.url.split("/"),a=r.split("/"),u={};if(c.length!==a.length)return;for(var n=0;n<c.length;n++){var p=a[n],d=c[n].replace(":","");d!==p&&(u[d]=p)}i.params=u,e.initService(i)}else o.push(i)}o.length===e.routes.length&&(t.innerHTML="404 page not found")},r.prototype.initService=function(e){var r=this,o=r.serviceHolder[e.service];t.classList.add("peach-transition"),r.initRouteController(o,e)},r.prototype.parse=function(e,t){var r=this;if(e.getAttribute){var o=e.getAttribute("peach-controller"),n={controller:o,name:t};r.loadInlineController(n,e,t)}},r.prototype.request=function(e,t,r,o){return new Promise(function(r,o){var n=new XMLHttpRequest;n.open(e,t,!0),n.onload=function(){if(this.status>=200&&this.status<300)r(n.response);else{var e={status:this.status,message:n.statusText};o(e)}},n.send()})},r.prototype.initRouteController=function(e,t,r){var o,n,i=this,l=i.config,s=t;l.templateUrl+"/"+t.template;if(t.getAttribute){var c={$render:function(e,t,r){this.renderTemplate(e,t,r)}};n=i.loadDependencies(i.controllerDependencies[r]),n.push(c),i.controllerHolder[r].apply(this,n)}else{var c={$route:s,$render:this.renderTemplate};o=i.loadDependencies(i.controllerDependencies[s.controller]),o.push(c),i.controllerHolder[s.controller].apply(this,o)}},r.prototype.renderTemplate=function(e,r,o){var n=document.querySelector("[peach-template="+e+"]").innerHTML;if(!r)return void console.warn("No data is set: ",r);if(n="var r = []; with(obj){r.push('"+n.replace(/[\r\n]/g," ").replace("&lt;","<").replace("&gt;",">").replace(/\{\{(.*?)\}\}/g,"');r.push($1);r.push('").replace(/\{\%/g,"');").replace(/\%\}/g,"r.push('")+"');}return r.join('');",this.source=new Function("obj",n),"add"===o)t.innerHTML+=this.source(r);else{if("render"===o)return this.source(r);t.innerHTML=this.source(r)}},window.Peach=r}();
